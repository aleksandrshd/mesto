(()=>{"use strict";const e=document.querySelector(".profile__edit-button"),t=document.querySelector(".profile__add-button"),s=document.querySelector(".profile__avatar"),i=document.querySelector(".element-template").content,n={};class o{constructor(e,t,s,{handleDeleteIconClick:i},n,o){this._link=e.link,this._name=e.name,this._likes=e.likes,this._id=e.id,this._ownerID=e.ownerID,this._userID=o,this._template=t,this._element=this._template.cloneNode(!0),this._cardElement=this._element.querySelector(".elements__card"),this._likeButton=this._element.querySelector(".elements__like-button"),this._likeCounter=this._element.querySelector(".elements__like-counter"),this._deleteButton=this._element.querySelector(".elements__delete-button"),this._imageElement=this._element.querySelector(".elements__image"),this._titleElement=this._element.querySelector(".elements__title"),this._handleCardClick=s,this._handleLikeClick=n,this._handleDeleteIconClick=i}_likeCard(){this._likeButton.addEventListener("click",(e=>{e.target.classList.toggle("elements__like-button_type_active"),this._handleLikeClick()}))}_setLikeStatus(){this.isLiked()?this._likeButton.classList.add("elements__like-button_type_active"):this._likeButton.classList.remove("elements__like-button_type_active")}_deleteCard(){this._deleteButton.addEventListener("click",(()=>{this._handleDeleteIconClick()}))}_openCardImage(){this._imageElement.addEventListener("click",(()=>{this._handleCardClick(this._name,this._link)}))}_setEventListeners(){this._likeCard(),this._deleteCard(),this._openCardImage()}_setDeleteButtonView(){this._deleteButton.classList.add(this._ownerID===this._userID?"elements__delete-button_visible":"elements__delete-button_hidden")}id(){return this._id}removeCard(){this._cardElement.remove()}isLiked(){return Boolean(this._likes.find((e=>e._id===this._userID)))}setLikesInfo(e){this._likeCounter.textContent=e.length,this._likes=e,this._setLikeStatus()}render(){return this._imageElement.src=this._link,this._imageElement.alt=this._name,this._titleElement.textContent=this._name,this._likeCounter.textContent=this._likes.length,this._setLikeStatus(),this._setEventListeners(),this._setDeleteButtonView(),this._element}}class r{constructor(e,t){this._form=document.querySelector(t),this._config=e,this._button=this._form.querySelector(this._config.button),this._spans=Array.from(this._form.querySelectorAll(this._config.error)),this._inputs=Array.from(this._form.querySelectorAll(this._config.input))}enableValidation(){this._form.addEventListener("input",(e=>this._handleFormInput(e)))}_handleFormInput(e){const t=e.target;this._showFieldError(t),this.setSubmitButtonState(),this._setInputState(t)}_showFieldError(e){e.nextElementSibling.textContent=e.validationMessage}setSubmitButtonState(){this._form.checkValidity()?(this._button.removeAttribute("disabled"),this._button.classList.remove(this._config.buttonDisabled)):(this._button.setAttribute("disabled",!0),this._button.classList.add(this._config.buttonDisabled))}_setInputState(e){e.checkValidity()?e.classList.remove(this._config.inputInvalid):e.classList.add(this._config.inputInvalid)}hideErrors(){this._spans.forEach((e=>e.textContent="")),this._inputs.forEach((e=>e.classList.remove(this._config.inputInvalid)))}}class a{constructor(e){this._popupSelector=e,this._popup=document.querySelector(this._popupSelector),this._closeButton=this._popup.querySelector(".popup__close-button"),this._handleEscClose=this._handleEscClose.bind(this)}_handleEscClose(e){"Escape"===e.key&&this.close()}_closePopupOnClick(e){e.target===this._popup&&this.close()}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._closeButton.addEventListener("click",(()=>this.close())),this._popup.addEventListener("click",(e=>this._closePopupOnClick(e)))}}class l extends a{constructor(e,{handleFormSubmit:t}){super(e),this._handleFormSubmit=t,this._form=this._popup.querySelector(".popup__form"),this._inputList=this._form.querySelectorAll(".popup__input")}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>this._handleFormSubmit(this._getInputValues(),e)))}close(){super.close(),this._form.reset()}setInputValues(e){this._inputList.forEach((t=>{t.value=e[t.name]}))}_getInputValues(){return this._formValues={},this._inputList.forEach((e=>{this._formValues[e.name]=e.value})),this._formValues}getSubmitButton(){return this._form.querySelector(".popup__save-button")}}let _=null;function h(e,t){m.open(e,t)}function u(e,t,s){t.textContent=e?"Сохранение ...":s}function c(e){const t=new o(e,i,h,{handleDeleteIconClick:()=>{v.open(),n["input_type_delete-card"].setSubmitButtonState(),v.setSubmitAction((e=>{e.preventDefault(),u(!0,v.getSubmitButton(),"Да"),d.deleteCard(t.id()).then((()=>{t.removeCard()})).catch((e=>console.log(`Ошибка: ${e}`))).finally((()=>{u(!1,v.getSubmitButton(),"Да"),v.close()}))}))}},(()=>{d.changeLikeCardStatus(t.id(),t.isLiked()).then((e=>{t.setLikesInfo(e.likes)})).catch((e=>console.log(`Ошибка: ${e}`)))}),_);return t.render()}const d=new class{constructor(e){this._adress=e.baseUrl,this._headers=e.headers}getInitialCards(){return fetch(`${this._adress}/cards`,{headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}getUserInfo(){return fetch(`${this._adress}/users/me`,{headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}setUserInfo(e,t){return fetch(`${this._adress}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e,about:t})}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}setNewCard(e,t){return fetch(`${this._adress}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}deleteCard(e){return fetch(`${this._adress}/cards/${e}`,{method:"DELETE",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}changeLikeCardStatus(e,t){return t?fetch(`${this._adress}/cards/${e}/likes`,{method:"DELETE",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`))):fetch(`${this._adress}/cards/${e}/likes`,{method:"PUT",headers:this._headers}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}setUserAvatar(e){return fetch(`${this._adress}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then((e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)))}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-50",headers:{authorization:"130914df-0f97-4df0-980a-19c8be58ffdc","Content-Type":"application/json"}}),p=new l(".popup-avatar",{handleFormSubmit:(e,t)=>{t.preventDefault(),u(!0,p.getSubmitButton(),"Сохранить"),d.setUserAvatar(e.avatar).then((e=>b.setUserAvatar(e.avatar))).catch((e=>console.log(`Ошибка: ${e}`))).finally((()=>{u(!1,p.getSubmitButton(),"Сохранить"),p.close()}))}});p.setEventListeners();const m=new class extends a{constructor(e){super(e),this._imagePicture=this._popup.querySelector(".popup__img"),this._imageCaption=this._popup.querySelector(".popup__caption")}open(e,t){this._imagePicture.src=t,this._imagePicture.alt=e,this._imageCaption.textContent=e,super.open()}}(".popup-image");m.setEventListeners();const f=new class{constructor({items:e,renderer:t},s){this._renderedItems=e,this._renderer=t,this._container=document.querySelector(s)}addItem(e){this._container.prepend(e)}renderItems(e){e.forEach((e=>this._renderer(e)))}}({renderer:e=>{f.addItem(c(e))}},".elements__list"),b=new class{constructor(e,t,s){this._nameSelector=e,this._jobSelector=t,this._avatarSelector=s,this._profileName=document.querySelector(this._nameSelector),this._profileJob=document.querySelector(this._jobSelector),this._profileAvatar=document.querySelector(this._avatarSelector)}getUserInfo(){return this._userInfo={name:this._profileName.textContent,job:this._profileJob.textContent},this._userInfo}setUserNameJob(e,t){this._profileName.textContent=e,this._profileJob.textContent=t}setUserInfo(e,t,s){this.setUserNameJob(e,t),this.setUserAvatar(s)}setUserAvatar(e){this._profileAvatar.style.backgroundImage=`url(${e})`}}(".profile__name",".profile__job",".profile__avatar");d.getUserInfo().then((e=>{b.setUserInfo(e.name,e.about,e.avatar),_=e._id})).then((()=>d.getInitialCards().then((e=>{f.renderItems(e.reverse().map((e=>({name:e.name,link:e.link,likes:e.likes,ownerID:e.owner._id,id:e._id}))))})))).catch((e=>console.log(`Ошибка: ${e}`)));const k=new l(".popup-profile",{handleFormSubmit:(e,t)=>{t.preventDefault(),u(!0,k.getSubmitButton(),"Сохранить"),d.setUserInfo(e.name,e.job).then((e=>b.setUserNameJob(e.name,e.about))).catch((e=>console.log(`Ошибка: ${e}`))).finally((()=>{u(!1,k.getSubmitButton(),"Сохранить"),k.close()}))}});k.setEventListeners();const S=new l(".popup-card",{handleFormSubmit:(e,t)=>{t.preventDefault(),u(!0,S.getSubmitButton(),"Создать"),d.setNewCard(e.title,e.link).then((e=>f.addItem(c({name:e.name,link:e.link,likes:e.likes,ownerID:e.owner._id,id:e._id})))).catch((e=>console.log(`Ошибка: ${e}`))).finally((()=>{u(!1,S.getSubmitButton(),"Создать"),S.close()}))}});S.setEventListeners();const v=new class extends a{constructor(e){super(e),this._form=this._popup.querySelector(".popup__form")}setSubmitAction(e){this._handleFormSubmit=e,this._form.addEventListener("submit",(e=>this._handleFormSubmit(e)))}getSubmitButton(){return this._form.querySelector(".popup__save-button")}}(".popup-delete-card");var g;v.setEventListeners(),g={button:".popup__save-button",buttonDisabled:"popup__save-button_type_disabled",error:".popup__error",input:".popup__input",inputInvalid:"popup__input_type_invalid"},Array.from(document.querySelectorAll(".popup__form")).forEach((e=>{const t=e.getAttribute("name"),s=new r(g,`.popup__form[name="${t}"]`);n[t]=s,s.enableValidation()})),e.addEventListener("click",(()=>{k.setInputValues(b.getUserInfo()),n.input_type_nameJob.setSubmitButtonState(),n.input_type_nameJob.hideErrors(),k.open()})),t.addEventListener("click",(()=>{n.input_type_titleLink.setSubmitButtonState(),S.open()})),s.addEventListener("click",(()=>{n.input_type_avatar.setSubmitButtonState(),p.open()}))})();